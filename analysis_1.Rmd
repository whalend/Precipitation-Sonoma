---
title: "analysis1"
author: "whalen"
date: "November 18, 2014"
output: html_document
---

Looking at the summaries it appears something rather sketchy is going on. The maximum values are way above a realistic range, with a maximum daily precipitation of over 52 inches and a maximum of hourly precipitation of over 14 inches. **Just. Not. Possible.** 
```{r dataframe summaries, echo=TRUE}
library(ggplot2)
library(plyr)
library(dplyr)
# These data files have already had the outliers replaced with `NA`
dy_rg_data <- readRDS("dy_rg_data.rds")
summary(dy_rg_data)
qplot(id, daily_ppt, data=dy_rg_data) + theme_bw()

hr_rg_data <- readRDS("hr_rg_data.rds")
summary(hr_rg_data)
qplot(date, hourly_ppt, data=hr_rg_data)
```

Exploring when and where these enormous anomalous values are coming from, first dealing with the daily events data frame. For reference, this pdf has some data on maximum rainfall recorded in California <http://www.cepsym.org/Sympro1994/goodridge_paper.pdf> Also more information here: <http://earthzine.org/2011/04/19/average-recurrence-interval-of-extreme-rainfall-in-real-time/> which I believe refers to the report from the first link.
```{r explore outliers, eval=FALSE, echo=FALSE}
library(plyr)
library(dplyr)
filter(dy_rg_data, daily_ppt>6)
filter(dy_rg_data, year==2007 & month==1 & day==28)
filter(dy_rg_data, year==2007 & month==1 & day==27)
filter(dy_rg_data, year==2008 & month==3 & day==15)
filter(dy_rg_data, date=="1/27/2007")

qplot(year, daily_ppt, data=dy_rg_data, facets= id ~.)
qplot(id, daily_ppt, data=dy_rg_data  %>% filter(date=="3/15/2008"))


qplot(hour, hourly_ppt, data=hr_rg_data %>% filter(date=="3/15/2008"), color=id)

filter(hr_rg_data, hourly_ppt>1)
filter(hr_rg_data, date=="3/15/2008" & id=="mitsui")
filter(hr_rg_data, year==2008 & month==3 & day==15 & hour==18)

```
I was thinking I should replace the outlying values with the average of the remaining values for that day or hour.

Francesco suggests that for aggregating to monthly, If more than 5 days of `NA`/missing for a month then treat entire month as missing. Maybe use a spline approach instead of regression kriging because of small number of points (FT, suggests thin plate spline).

For outlier replacement I settled on a daily precipitation threshold of greater than or equal to 6 inches, and an hourly precipitation threshold of greater than or equal to 1 inch.
```{r outliers to NA, eval=FALSE, echo=TRUE}
# Replace ppt values >= 6 with `NA`
dy_rg_data$daily_ppt[dy_rg_data$daily_ppt>=6] <- NA

qplot(as.numeric(year), daily_ppt, data = dy_rg_data %>% 
            group_by(id, year, month, day), color = id) # + 
      # geom_text(aes(label=id),hjust=-0.1, vjust=0)

qplot(month, monthly_ppt, data = dy_rg_data %>% 
            filter(year==2006) %>%
            group_by(id, year, month) %>%
            summarize(monthly_ppt=sum(daily_ppt)), 
      color = id, geom = 5, main = "Monthly total from daily data - 2006") #+
      geom_point(shape = 5, size = 1.5)

# An implementation of the `qplot` above using `ggplot`
ggplot(data = dy_rg_data %>% 
            filter(year==2006) %>%
            group_by(id, year, month) %>%
            summarize(monthly_ppt=sum(daily_ppt)),
       aes(x = month, y = monthly_ppt, color = id)) +
      geom_point(size=2, shape=3)

#Replace hourly_ppt values >= 1
hr_rg_data$hourly_ppt[hr_rg_data$hourly_ppt>=1]  <- NA

qplot(month, monthly_ppt, data = hr_rg_data %>%
      filter(year==2006) %>%
            group_by(id, year, month) %>%
            summarize(monthly_ppt=sum(hourly_ppt)), color = id,
      main="Monthly total from hourly data - 2006")


```


Francesco talking over the exploration with me
```{r explore with francesco, eval=FALSE}
test=dy_rg_data$date2[order(dy_rg_data$date2), ]
test=dy_rg_data[order(dy_rg_data$date2), ]
head(test)
head(test,40)
test=dy_rg_data[order(dy_rg_data$date2,dy_rg_data$id), ]
```


A couple of rain gauges have been moved to new locations near their established areas over the years, so I have shapefiles corresponding the move of one or more gauge stations.
```{r list rain gague shapefiles}
list.files("shapefiles", pattern = "*.shx")
```
This shows that there are four shapefiles for various stretches of the study, 2003-2008, 2009-2011, 2012-2014, and then 2015 and beyond. The 2015 is the result of moving a rain gauge during our 2014 visits. I will not be using that file for the data I have in hand.


```{r breakdown years by shapefiles}
library(rgdal)# GDAL bindings for R; I believe this requires GDAL installed for your operating system
ogrListLayers("shapefiles")
rg_0308 <- readOGR(dsn="shapefiles", layer="RainGauges2003_2008")
str(rg_0308)
rg_0308@data$NAME
rg_0308@data$NAME <- tolower(rg_0308@data$NAME)
rg_0308@data$NAME[rg_0308@data$NAME=="macki"] <- "mackie"
rg_0308@data$NAME[rg_0308@data$NAME=="sdc"] <- "sec"
rg_0308@data$NAME[rg_0308@data$NAME=="sugar"] <- "sugarloaf"
unique(dy_rg_data$id)

month_rg_0308 <- dy_rg_data %>%
      group_by(id, year, month) %>% 
      filter(year<=2008) %>%
      summarise(monthly_ppt = sum(daily_ppt))
month_rg_0308$id <- as.factor(month_rg_0308$id)
summary(month_rg_0308)
```

```{r geostats}
library(sp)
library(raster)
library(rgdal)
elev <- raster("dem/sod15m.tif")
str(elev)
crs <- elev@crs
rg_0308 <- spTransform(rg_0308, CRS=crs)
str(rg_0308)
spplot(elev, scales=list(draw=T), sp.layout=list("sp.points", rg_0308))

rg_0308@data$elev <- extract(elev, rg_0308)
str(rg_0308)
#spplot(slope, scales=list(draw=T), sp.layout=list("sp.points", depth, pch="+"))
```

Joining monthly precipitation data to spatial points data frame
```{r joining data}
rg_0308@data <- inner_join(rg_0308@data, month_rg_0308, by = c("NAME" = "id"))
str(month_rg_0308)
str(rg_0308)
summary(rg_0308)
```

Plotting precipitation against elevation for a subset of the data
```{r plot elevation precip}
rg08 <- filter(rg_0308@data, year==2008)
qplot(rg_0308@data$elev, rg_0308@data$monthly_ppt)
qplot(elev, monthly_ppt, data = rg08, facets = .~ month, color = NAME, main = "2008 Rain")
qplot(elev, monthly_ppt, data = rg08 %>% filter(month==1), color = NAME, main = "January 2008 Rain") + geom_text(aes(label=NAME),hjust=-0.1, vjust=0)
```

Developing a linear modeling for kriging
```{r rk model jan 2008}
rg_0108 <- subset(rg_0308@data, year==2008 & month==1)
#coordinates(rg_0108) = ~NORTHING+EASTING
str(rg_0108)
rg_0308 <- readOGR(dsn="shapefiles", layer="RainGauges2003_2008")
rg_0308 <- spTransform(rg_0308, CRS=crs)
rg_0108@proj4string <- rg_0308@proj4string
rg_0108 <- spTransform(rg_0108, CRS=crs)

elev_ppt = overlay(as(elev, "SpatialGridDataFrame"), rg_0108)   # create grid-points overlay
   # copy the slope values
lm_rg_0108 <- lm(monthly_ppt ~ elev, rg_0108)
summary(lm_rg_0108)
```


```{r thin plate spline}
library(fields)
loc_matrix <- cbind(rg_0108$NORTHING,rg_0108$EASTING)
ppt <- c(rg_0108$monthly_ppt)
jan08tps <- Tps(loc_matrix, ppt)
summary(jan08tps)
plot(jan08tps)
surface(jan08tps)

look <- predict(jan08tps, lambda = 2.0)
look <- predict(jan08tps, df = 4)

tps1 <- Tps(loc_matrix, ppt, df = 4)
summary(tps1)
set.panel(2,2)
plot(tps1)
set.panel()

out_jan08 <- predictSurface(jan08tps)
image(out_jan08)

fit <- Tps(ozone$x, ozone$y)
set.panel(2,2)
plot(fit)

```
